<!DOCTYPE html>
<!--
Copyright (C) 2022 Academy of Sciences Library

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="cs" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${appName}">callback</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="shortcut icon" href="/bankid-registrator/img/favicon.ico" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.css" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/filepond/dist/filepond.min.css" type="text/css" />
    <style>
        #files-control {
            display: none;
        }

        #files {
            display: block;
            width: 100%;
        }

        .filepond--drop-label {
            color: #4c4e53;
        }

        .filepond--label-action {
            text-decoration-color: #babdc0;
        }

        .filepond--panel-root {
            border-radius: 2em;
            background-color: #edf0f4;
            height: 1em;
        }

        .filepond--item-panel {
            background-color: #595e68;
        }

        .filepond--drip-blob {
            background-color: #7f8a9a;
        }

        .filepond--credits {
            display: none;
        }
    </style>
</head>

<body>
    <form action="#" th:action="@{/new-registration}" th:object="${patron}" method="post" enctype="multipart/form-data"
        class="my-5 space-y-4 max-w-4xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input class="hidden" type="text" th:field="*{patronId}" />
            <input class="hidden" type="text" th:field="*{bankIdSub}" />
            <div>
                <label for="firstname" class="block text-sm font-medium text-gray-700">Jméno *</label>
                <input type="text" id="firstname" name="firstname"
                    class="mt-1 block w-full p-2 border border-gray-300 bg-gray-50 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    th:field="*{firstname}" required readonly />
            </div>
            <div>
                <label for="lastname" class="block text-sm font-medium text-gray-700">Příjmení *</label>
                <input type="text" id="lastname" name="lastname"
                    class="mt-1 block w-full p-2 border border-gray-300 bg-gray-50 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    th:field="*{lastname}" required readonly />
            </div>
            <div>
                <label for="birthday" class="block text-sm font-medium text-gray-700">Datum narození *</label>
                <input type="date" id="birthday" name="birthday"
                    class="mt-1 block w-full p-2 border border-gray-300 bg-gray-50 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    th:value="${T(cz.cas.lib.bankid_registrator.util.DateUtils).convertAlephDate(patron.birthDate)}"
                    required readonly />
            </div>
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">E-mail *</label>
                <input type="email" id="email" name="email"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    th:field="*{email}" required />
            </div>
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700">Mobil *</label>
                <input type="tel" id="phone" name="phone"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    th:field="*{smsNumber}" required />
            </div>
            <div>
                <label for="rfid" class="block text-sm font-medium text-gray-700">RFID (Lítačka, ISIC apod.)</label>
                <input type="text" id="rfid" name="rfid"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    th:field="*{rfid}" />
            </div>
            <div class="md:col-span-2">
                <fieldset class="space-y-2">
                    <legend class="block text-sm font-medium text-gray-700">Adresa trvalého pobytu *</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="permanent_address_line1" placeholder="Název"
                            class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            th:field="*{address0}" required readonly />
                        <input type="text" name="permanent_address_line2" placeholder="Ulice a číslo domu"
                            class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            th:field="*{address1}" required readonly />
                        <input type="text" name="permanent_address_line3" placeholder="Obec"
                            class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            th:field="*{address2}" required readonly />
                        <input type="text" name="permanent_zip" placeholder="PSČ"
                            class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            th:field="*{zip}" required readonly />
                    </div>
                </fieldset>
            </div>
            <div class="md:col-span-2">
                <fieldset class="space-y-2">
                    <legend class="block text-sm font-medium text-gray-700">Kontaktní adresa (vyplňte pokud se liší od
                        adresy trvalého pobytu)</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="contact_address_line1" placeholder="Název"
                            class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            th:field="*{contactAddress0}">
                        <input type="text" name="contact_address_line2" placeholder="Ulice a číslo domu"
                            class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            th:field="*{contactAddress1}">
                        <input type="text" name="contact_address_line3" placeholder="Obec"
                            class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            th:field="*{contactAddress2}">
                        <input type="text" name="contact_zip" placeholder="PSČ"
                            class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            th:field="*{contactZip}">
                    </div>
                </fieldset>
            </div>
            <div class="md:col-span-2">
                <label for="language" class="block text-sm font-medium text-gray-700">Jazyk komunikace *</label>
                <select id="language" name="language"
                    class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                    th:field="*{conLng}" required />
                <option th:value="CZE">čeština</option>
                <option th:value="ENG">angličtina</option>
                </select>
            </div>
        </div>
        <div class="flex items-center mt-4">
            <input id="isCasEmployee" name="isCasEmployee" type="checkbox"
                class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
                th:checked="*{isCasEmployee == TRUE}" th:field="*{isCasEmployee}" />
            <label for="isCasEmployee" class="ml-2 mb-0 text-sm font-medium text-gray-700">Jsem zaměstnancem AV ČR</label>
        </div>
        <div id="files-control" class="flex flex-col items-center mt-4 pl-4">
            <label for="media" class="block text-sm font-medium text-gray-700">Nahrajte občanský průkaz, pas nebo jiný doklad totožnosti *</label>
            <input id="files" type="file" class="filepond mb-0" name="media[]" multiple data-max-file-size="10MB" data-max-files="3" />
        </div>
        <div class="flex items-center mt-4">
            <input id="consent" name="consent" type="checkbox"
                class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"
                th:checked="*{exportConsent == 'Y'}" th:field="*{exportConsent}" th:value="Y" required />
            <label for="consent" class="ml-2 mb-0 text-sm font-medium text-gray-700">Souhlasím se zpracováním osobních
                údajů *</label>
        </div>
        <button type="submit"
            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-4">
            <span th:if="${patron.isNew}">Nová registrace</span>
            <span th:if="${!patron.isNew}">Prodloužení registrace</span>
        </button>
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
    <script src="https://unpkg.com/filepond-plugin-file-encode/dist/filepond-plugin-file-encode.min.js"></script>
    <script src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.min.js"></script>
    <script src="https://unpkg.com/filepond-plugin-image-exif-orientation/dist/filepond-plugin-image-exif-orientation.min.js"></script>
    <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.min.js"></script>
    <script src="https://unpkg.com/filepond/dist/filepond.min.js"></script>
    <script>
        constApiUrl = "/bankid-registrator/api";
        const filesElm = document.getElementById('files');
        const filesInputElm = document.querySelector('[name="media[]"]');
        const filesWrapper = document.getElementById('files-control');

        function showAlert(type, message) {
            const mainElm = document.querySelector("form");
            const alert = document.createElement("div");
            const typeCss = {
                success: "green",
                danger: "red", 
            };

            alert.className = `relative block w-full p-4 mb-4 text-base leading-5 text-white bg-${typeCss[type]}-500 rounded-lg opacity-100 font-regular`;
            alert.textContent = message;

            mainElm.prepend(alert);

            setTimeout(() => {
                mainElm.removeChild(alert);
            }, 3000);
        }

        const checkRfid = async (rfid, bid, patronId) => {
            const response = await fetch(`${constApiUrl}/check-rfid`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams({
                    rfid: rfid,
                    bid: bid,
                    patronId: patronId
                })
            });

            if (!response.ok) {
                alert(`HTTP-Error: ${response.status} ${response.error}`);
            }

            const data = await response.json();
            return data;
        }

        FilePond.registerPlugin(
            FilePondPluginFileEncode,
            FilePondPluginFileValidateSize,
            FilePondPluginImageExifOrientation,
            FilePondPluginImagePreview
        );

        FilePond.create(filesElm);

        document.getElementById('rfid').addEventListener('change', (ev) => {
            const rfidElm = ev.target;
            const rfid = rfidElm.value;
            const bid = document.querySelector('input[name="bankIdSub"]').value;
            let patronId = document.querySelector('input[name="patronId"]').value;

            if (bid.trim().length === 0) {
                this.value = '';
                showAlert('danger', 'An error occurred while checking the RFID.');
                return;
            }

            if (rfid.trim().length === 0) {
                return;
            }

            if (patronId.trim().length === 0) {
                patronId = null;
            }

            checkRfid(rfid, bid, patronId)
                .then(data => {
                    if (data.result === true) {
                        rfidElm.value = '';
                        showAlert('danger', 'The RFID already exists.');
                    } else {
                        showAlert('success', 'The RFID is available.');
                    }
                })
                .catch(error => {
                    rfidElm.value = '';
                    showAlert('danger', 'An error occurred while checking the RFID.');
                });
        });

        document.getElementById("isCasEmployee").addEventListener("change", (ev) => {
            const casEmployee = ev.target;
            const casEmployeeValue = casEmployee.checked;

            if (casEmployeeValue) {
                filesInputElm.required = true;
                filesWrapper.style.display = "block";
            } else {
                filesInputElm.required = false;
                filesWrapper.style.display = "none";
            }
        });
    </script>
</body>

</html>